<!DOCTYPE html>
<html>
<head>
<title>Brad Johnson: Rails Multitenancy with Pundit</title>
<meta content='I just finished building my first multi-tenant app with Rails. I used Pundit&amp;rsquo;s policy scopes to handle scoping the index views, and used a...' name='description'>
<meta charset='utf-8'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='True' name='HandheldFriendly'>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/images/favicon.ico" rel="icon" type="image/ico" />
<link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
<link href='//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400' rel='stylesheet' type='text/css'>
</head>
<body class='post-template nav-closed'>
<div class='nav'>
<h3 class='nav-title'>Menu</h3>
<a class='nav-close' href='#'>
<span class='hidden'>Close</span>
</a>
<ul>
<li class='nav-home' role='presentation'>
<a href='/'>Home</a>
</li>
<li class='nav-github' role='presentation'>
<a href='https://github.com/cdale77'>GitHub</a>
</li>
</ul>
<a class='subscribe-button icon-feed' href='/feed.xml'>Subscribe</a>
</div>
<span class='nav-cover'></span>

<div class='site-wrapper'>
<header class='main-header no-cover post-head'>
<nav class='main-nav clearfix'>
<a class='menu-button icon-menu' href='#'>
<span class='word'>Menu</span>
</a>
</nav>
</header>
<main class='content' role='main'>
<article class='post'>
<header class='post-header'>
<h1 class='post-title'>Rails Multitenancy with Pundit</h1>
<section class='post-meta'>
<time class='post-date' datetime='2014-06-17'>
17 June 2014
</time>
on <a href='/tag/rails/'>rails</a>, <a href='/tag/pundit/'>pundit</a>
</section>
</header>
<section class='post-content'><p>I just finished building my first multi-tenant app with Rails. I used Pundit&rsquo;s policy scopes to handle scoping the index
views, and used a many-to-many relationship between users and my tenant model. Below is a description of how I set
everything up.</p>

<h2>Problem</h2>

<p>My app currently has these (and more) models: User, Company, Customer, Payment. The relationships were straightforward:
Users belonged to a Company, which had many Customers. A customer had many Payments. The app is primarily an accounting
application, and using it consisted of admin-level users logging in and performing the same set of tasks for each Company. This
is the desired workflow. My task was to allow this workflow to continue, but to allow each Company&rsquo;s users to log in and
access most of those same tasks.</p>

<p>While researching this, I concluded there were two main approaches to handling multitenancy with Rails: 
*Use scopes, as described by <a href="http://railscasts.com/episodes/388-multitenancy-with-scopes">Ryan Bates</a>
*Use database schemas, like the <a href="https://github.com/influitive/apartment">Apartment gem</a></p>

<h2>Solution</h2>

<p>My first solution was to use scopes in the controller like Ryan Bates does, combined with namespacing controllers to
handle some of the features that only admin users could access. This proved to be overly complex and lead to lots of
repeated code. So I refactored the app along the following lines, and I am pleased with the result. </p>

<h3>Tenant model</h3>

<p>The first step is to decide what tenant model the application will use. In my application the Company model was the
clear choice. You may have to create a Tenant model. </p>

<h3>Users-tenants</h3>

<p>My app has several views that should only show records which the current user can access. For example, the
customer#index action should only return Customers that are related to a Company which is related to the current user.
The first step to accomplishing this is to define the relationship between Users and your tenant model, Company in my
case. The easiest way to do this is to have a User belong to a Company, which can have many Users. This isn&rsquo;t ideal, 
however, because you probably have some users that should be able to access many Companies. In my case all my app&rsquo;s
existing users needed to access all the existing Companies. In this case a many-to-many relationship is the right
way to go. </p>

<p>In Rails (4, at least) there are two main ways to accomplish this: has<em>and</em>belongs<em>to</em>many, and has<em>many: :through. I 
went with the latter method after the former would not work for me. The first step was to remove the company</em>id field
from my User model. After that, I created the following migration</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>class CreateCompanyUsers &lt; ActiveRecord::Migration
  def change
    create_table :company_users do |t|
      t.belongs_to :compnay
      t.belongs_to :user
      t.timestamps
    end
    add_index :company_users, [:company_id, :user_id], unique: true
  end
end
</pre></td></tr></tbody></table>
</div>

<p>Then a simple model file</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>class CompanyUser &lt; ActiveRecord::Base
  belongs_to :compnay
  belongs_to :user
end
</pre></td></tr></tbody></table>
</div>

<p>In the User model, I added these two lines</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>has_many :company_users
has_many :companies, through: :company_users
</pre></td></tr></tbody></table>
</div>

<p>In the Company model</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>has_many :company_users
has_many :users, through: :company_users
</pre></td></tr></tbody></table>
</div>

<p>These changes are sufficient to set up a many-to-many relationship, so that a User can be associated with many Companies
and vise versa. </p>

<h3>User roles</h3>

<p>I had a previously set up a roles system for Users. In config/application.rb, I have this</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>config.user_roles = %w[staff manager admin super_admin]
</pre></td></tr></tbody></table>
</div>

<p>My User model has a role column which stores a string, and I have the following in the Role model file</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre>def role?(base_role)
  role.present? &amp;&amp; User.roles.index(base_role.to_s) &lt;= User.roles.index(role)
end

private
  def self.roles
    Lupine::Application.config.user_roles
  end
</pre></td></tr></tbody></table>
</div>

<p>This allows me to do things like this in controllers or policies</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>current_user.role? :admin
</pre></td></tr></tbody></table>
</div>

<p>That method will return true if the current user&rsquo;s role is &lsquo;admin&rsquo; or &#39;super_admin&rsquo;, and false if the role is &ldquo;, 
&#39;staff&rsquo;, or &#39;manager&rsquo;</p>

<h3>Authorization</h3>

<p>I&rsquo;ve been using <a href="https://github.com/elabs/pundit">Pundit</a> for authorization, and really like it. Pundit has a handy
solution to the problem of authorization scopes - providing records to which the current user has access. The writeup
in their docs is good, and I won&rsquo;t duplicate it here. </p>

<p>In order to use policy scopes you need to have a class method that takes a user as an argument and returns a collection
of authorized records. There might be other ways to make it work, but this is what I did and is the most obvious approach.
I have already detailed the relationship between Users and the tenant model. To make this work, you also need a relationship
between the tenant model and all the child models. In my app that meant I needed to create a direct one-to-many 
relationship between Company and Payment. In addition to that change, I did a few more things.</p>

<p>First I changed the Company, Customer, and Payment models to have a users relationship/method. This was easy to 
accomplish using has_many :users, though: :company  since both models relate to Company, the tenant model. </p>

<p>Then I created a concern with the following method</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>module ModelScopes
  def user_records(user)
    select { |record| record.users.include?(user) }
  end
end
</pre></td></tr></tbody></table>
</div>

<p>I extended Company, Customer, and Payment with this module. Now I had a class method, ::user_records, that would return
the correct records. I could use this method with Pundit&rsquo;s policy scopes like this</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>  class Scope &lt; Struct.new(:user, :scope)
    def resolve
      scope.user_records(user)
    end
  end
</pre></td></tr></tbody></table>
</div>

<p>This worked well, except for one problem. Using ::select returns an Array, not an ActiveRecord::Relation. Pundit expects
the latter and uses that to decide what policy class to use. Fixing this turned out to be fairly easy. I simply
wrote my own authorize method. My controllers now look like this, and things are working nicely. 
    class CompaniesController &lt; ApplicationController</p>
<div class="highlight plaintext"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>  include Pundit
  after_filter :verify_policy_scoped, only: :index
  after_filter :verify_authorized, except: :index

  def index
    @campaigns = policy_scope(Campaign)
    raise Pundit::NotAuthorized unless current_user.role? :staff
  end

end
</pre></td></tr></tbody></table>
</div>

<p>When a user visits
the Company index view, she sees all the companies to which she is related. I can take advantage of the current_user 
method to restrict this action based on a user&rsquo;s role, as well. This gives me a fairly good degree of flexibility, is 
simple, and keeps things nice and separated.</p>

<p>One drawback is that I cannot test my my policies for correct behavior on the index action. I&rsquo;ll cover this area of the
application with a model-level test to ensure the correct records are being returned, and with an feature-level spec
to make sure it all works together. </p>
</section>
<footer class='post-footer'>
<section class='author'>
<h4>
<a href='/author/brad-johnson/'>Brad Johnson</a>
</h4>
<p></p>
Read
<a href='/author/brad-johnson/'>more posts</a>
by this author.
</section>
<section class='share'>
<h4>Share this post</h4>
<a class='icon-twitter' href='https://twitter.com/share?text=Rails Multitenancy with Pundit&amp;amp;url=http://www.bradleymosesjohnson.com/2014/06/17/rails-multitenancy-with-pundit/' onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
<span class='hidden'>Twitter</span>
</a>
<a class='icon-facebook' href='https://www.facebook.com/sharer/sharer.php?u=http://www.bradleymosesjohnson.com/2014/06/17/rails-multitenancy-with-pundit/' onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
<span class='hidden'>Facebook</span>
</a>
<a class='icon-google-plus' href='https://plus.google.com/share?url=http://www.bradleymosesjohnson.com/2014/06/17/rails-multitenancy-with-pundit/' onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
<span class='hidden'>Google+</span>
</a>
</section>
</footer>
</article>
</main>
<aside class='read-next'>
<a class='no-cover read-next-story' href='/2014/06/17/sendy-on-ec2/'>
<section class='post'>
<h2>Sendy on EC2</h2>
<p>I&rsquo;m doing some work for a nonprofit organization with a growing email list. Last month we passed 10,000 subscribers.&hellip;</p>
</section>
</a>
<a class='no-cover prev read-next-story' href='/2014/07/09/multitenancy-part-two/'>
<section class='post'>
<h2>Multitenancy Part Two</h2>
<p>In my previous post I wrote about who to create a multi-tenant Rails application using the Pundit gem. I&rsquo;ve&hellip;</p>
</section>
</a>
</aside>

<footer class='site-footer clearfix'>
<section class='copyright'>
<a href='/'>Brad Johnson</a>
&copy;
2015
</section>
<section class='poweredby'>
Casper theme powered by
<a href='https://ghost.org'>Ghost</a>
</section>
</footer>
</div>
<script src="/javascripts/application.js" type="text/javascript"></script>
</body>
</html>
